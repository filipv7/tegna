<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kontakt / Bestilling — Firma</title>
  <meta name="description" content="Kontaktformular — send oss en forespørsel" />

  <style>
    :root{
      --bg:#f7f9fb;
      --card:#fff;
      --muted:#6b7280;
      --primary:#0b70ff;
      --maxw:900px;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    body{margin:0;background:var(--bg);color:#111;line-height:1.5}
    .site-header{background:#fff;border-bottom:1px solid #e6eef8;padding:1rem}
    .container{max-width:var(--maxw);margin:0 auto;padding:1rem}
    h1,h2{margin:.5rem 0}
    .muted{color:var(--muted)}
    main{padding:2rem 0}
    .card{background:var(--card);padding:1rem;border-radius:8px;box-shadow:0 4px 12px rgba(15,23,42,.04)}
    .contact{padding:2rem}
    .contact-form{display:grid;grid-template-columns:1fr;gap:.75rem;align-items:start}
    label{font-weight:600;font-size:.95rem}
    input[type="text"], input[type="email"], input[type="tel"], textarea, select {
      width:100%;padding:.6rem .75rem;border:1px solid #d0d7e3;border-radius:6px;background:var(--card);font-size:1rem
    }
    .form-row{display:flex;flex-direction:column;gap:.35rem}
    .btn{display:inline-block;background:var(--primary);color:white;padding:.6rem .85rem;border:none;border-radius:6px;cursor:pointer}
    .btn[disabled]{opacity:.6;cursor:wait}
    .help{font-size:.9rem;color:var(--muted)}
    .hidden-field{position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden}
    .form-success{padding:1rem;border-radius:6px;background:#ecfdf5;color:#064e3b;margin-top:.75rem;border:1px solid #bbf7d0}
    .form-error{padding:1rem;border-radius:6px;background:#fff1f2;color:#7f1d1d;margin-top:.75rem;border:1px solid #fecaca}
    .calc{display:grid;grid-template-columns:1fr 1fr;gap:0.75rem;align-items:end}
    @media(max-width:700px){ .calc{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header class="site-header">
    <div class="container">
      <h1>Firma</h1>
    </div>
  </header>

  <main class="container" id="main">
    <section class="card contact" aria-labelledby="kontakt-heading">
      <h2 id="kontakt-heading">Kontakt oss / Bestill</h2>
      <p class="muted">Send oss en forespørsel, så tar vi kontakt innen kort tid.</p>

      <!-- Jednostavan kalkulator cene -->
      <div class="card" style="margin-bottom:1rem">
        <h3>Beregn pris</h3>
        <div class="calc" id="price-calc">
          <div class="form-row">
            <label for="produkt">Pakketype</label>
            <select id="produkt" name="produkt">
              <option value="basic" data-price="1000">Basic — 1 000 kr</option>
              <option value="standard" data-price="2000">Standard — 2 000 kr</option>
              <option value="premium" data-price="3500">Premium — 3 500 kr</option>
            </select>
          </div>

          <div class="form-row">
            <label for="kolicina">Količina</label>
            <input id="kolicina" type="number" min="1" step="1" value="1">
          </div>

          <div class="form-row" style="grid-column:1 / -1">
            <label for="total">Total pris</label>
            <input id="total" type="text" readonly aria-readonly="true" value="1000 kr">
            <small class="help">Prisen vil bli sendt sammen med bestillingen.</small>
          </div>
        </div>
      </div>

      <!-- Netlify form -->
      <form
        name="kontakt"
        method="POST"
        data-netlify="true"
        data-netlify-honeypot="bot-field"
        class="contact-form"
        id="kontakt-form"
        novalidate
      >
        <input type="hidden" name="form-name" value="kontakt">
        <!-- honeypot -->
        <p class="hidden-field" aria-hidden="true">
          <label>Don't fill this out if you're human: <input name="bot-field" tabindex="-1" autocomplete="off"></label>
        </p>

        <!-- skriveno polje za cijenu iz kalkulatora -->
        <input type="hidden" name="calculated_price" id="calculated_price" value="1000">

        <div class="form-row">
          <label for="navn">Navn</label>
          <input id="navn" type="text" name="navn" required aria-required="true" autocomplete="name" />
        </div>

        <div class="form-row">
          <label for="email">E‑post</label>
          <input id="email" type="email" name="email" required aria-required="true" autocomplete="email" />
        </div>

        <div class="form-row">
          <label for="telefon">Telefon (valgfritt)</label>
          <input id="telefon" type="tel" name="telefon" inputmode="tel" pattern="[0-9+()\- \s]*" placeholder="+47 123 45 678" autocomplete="tel">
        </div>

        <div class="form-row">
          <label for="melding">Melding</label>
          <textarea id="melding" name="melding" rows="5" required aria-required="true"></textarea>
        </div>

        <div>
          <!-- Napomena: nakon uspješnog ajax slanja, klijent će biti preusmjeren na /bestilling -->
          <button type="submit" class="btn btn-primary" id="submit-btn">Send forespørsel / Bestill</button>
        </div>

        <div id="form-result" role="status" aria-live="polite"></div>
      </form>
    </section>
  </main>

  <footer class="container">
    <p>&copy; <span id="year"></span> Firma — Alle rettigheter reservert</p>
  </footer>

  <script>
    // Helper: encode object for application/x-www-form-urlencoded
    function encode(data) {
      return Object.keys(data)
        .map(function(key) {
          return encodeURIComponent(key) + '=' + encodeURIComponent(data[key]);
        })
        .join('&');
    }

    // Kalkulator logika
    (function(){
      var produktSel = document.getElementById('produkt');
      var kolicinaInput = document.getElementById('kolicina');
      var totalInput = document.getElementById('total');
      var calculatedPriceInput = document.getElementById('calculated_price');

      function getSelectedPrice() {
        var opt = produktSel.selectedOptions[0];
        return parseFloat(opt.dataset.price || 0);
      }

      function updateTotal() {
        var cena = getSelectedPrice();
        var kolicina = Math.max(1, parseInt(kolicinaInput.value || 1, 10));
        var total = cena * kolicina;
        totalInput.value = total.toLocaleString('no-NB') + ' kr';
        calculatedPriceInput.value = total; // ovo se pošalje u formi
      }

      produktSel.addEventListener('change', updateTotal);
      kolicinaInput.addEventListener('input', updateTotal);
      updateTotal();
    })();

    // Form submit: Ajax prema Netlify i redirect na /bestilling nakon uspjeha
    (function(){
      document.getElementById('year').textContent = new Date().getFullYear();

      var form = document.getElementById('kontakt-form');
      var submitBtn = document.getElementById('submit-btn');
      var resultEl = document.getElementById('form-result');

      function showMessage(msg, success){
        resultEl.innerHTML = '';
        var div = document.createElement('div');
        div.className = success ? 'form-success' : 'form-error';
        div.textContent = msg;
        resultEl.appendChild(div);
      }

      form.addEventListener('submit', function(e){
        e.preventDefault(); // mi preuzimamo kontrolu i odlučujemo kad poslati

        // checkValidity() radi i kada je form novalidate, pa ćemo koristiti taj rezultat
        if (!form.checkValidity()) {
          showMessage('Vennligst fyll inn alle obligatoriske felter korrekt.', false);
          // fokusiraj prvo nevalidno polje za bolji UX
          var firstInvalid = form.querySelector(':invalid');
          if (firstInvalid) firstInvalid.focus();
          return;
        }

        if (submitBtn.disabled) return;
        submitBtn.disabled = true;
        var originalText = submitBtn.textContent;
        submitBtn.textContent = 'Sender...';

        // build form data object (uključuje skrivena polja)
        var formData = new FormData(form);
        // Important: Netlify expects "form-name" field present - imamo hidden input form-name
        // Convert FormData to urlencoded string
        var obj = {};
        formData.forEach(function(value, key){
          // If multiple values with same key, Netlify will accept repeated keys, but for simplicity:
          if (obj[key] !== undefined) {
            // convert to comma-separated if duplicate
            obj[key] = obj[key] + ',' + value;
          } else {
            obj[key] = value;
          }
        });

        // Send to Netlify
        fetch('/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: encode(obj)
        }).then(function(response){
          if (response.ok) {
            // success: redirect to bestilling page (možeš promijeniti URL)
            // Ako želiš da bestilling prikaže podatke koje smo poslali, možeš umjesto redirekta prikazati inline poruku ili koristiti query parametre.
            window.location.href = '/bestilling';
          } else {
            return response.text().then(function(text){
              throw new Error(text || 'Server returned ' + response.status);
            });
          }
        }).catch(function(err){
          console.error('Form submit failed:', err);
          showMessage('Noe gikk galt ved innsending. Prøv igjen senare.', false);
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        });
      });
    })();
  </script>
</body>
</html>
